# Enhanced Hydration Features - 增强饮水功能

## Context 背景

HydrateMate 是一款森林主题的饮水追踪应用，需要进行功能增强。用户希望：
1. 添加更细粒度的喝水选项（如"一小口"）
2. 增强数据分析功能，提供更多洞察
3. 实现植物状态变化的自然生长动画

**注意**: Capacitor 打包由用户自行处理，本次开发需确保代码兼容 Capacitor 打包。

### 当前状态

**已有能力：**
- 6 种饮水选项（50ml-500ml）+ 自定义容量
- 4 阶段植物生长可视化（胚芽/萌芽/幼苗/成树）
- 基础统计：周/月统计、小时分布、饮品类别、周对比趋势
- React + TypeScript 前端，Go + Gin 后端

**约束条件（中国市场）：**
- Google Fonts (fonts.googleapis.com) 被屏蔽
- Tailwind CDN (cdn.tailwindcss.com) 可能受影响
- 无现有 Capacitor 配置
- 需要自托管所有外部资源

---

## Requirements 需求规格

### R1: 扩展饮水选项

**描述**：添加更细粒度的饮水量选项，特别是小口饮水（30ml）

#### 场景 R1.1: 快速记录一小口水
- **Given**: 用户在首页
- **When**: 打开饮水选择器
- **Then**: 显示"一小口 (30ml)"选项，图标为小水滴
- **验证**: 选择后正确记录 30ml，类别为 water

#### 场景 R1.2: 保持网格布局美观
- **Given**: 饮水选项从 6 个增加到 7 个
- **When**: 渲染饮水选择器
- **Then**: 自动调整为 2 列或滚动布局，不破坏视觉平衡

#### 约束
- 新选项必须遵循现有 `DrinkOption` 接口
- 使用 lucide-react 图标库
- 颜色方案：水类饮品使用蓝色系

---

### R2: 增强数据分析（全部功能）

**描述**：实现完整的数据分析功能集，作为应用的核心竞争力

#### R2.1: 连续达标天数（Streak）

**场景 R2.1.1: 显示连续达标天数**
- **Given**: 用户连续 5 天完成饮水目标
- **When**: 查看统计页面
- **Then**: 显示 "🔥 连续达标 5 天"
- **验证**: 数据库 streak_days 字段正确更新

**场景 R2.1.2: 中断后重新计数**
- **Given**: 用户昨天未达标
- **When**: 今天达标后查看
- **Then**: 显示 "连续达标 1 天"

#### R2.2: 最佳饮水时段分析

**场景 R2.2.1: 识别高效饮水时段**
- **Given**: 用户有 7 天以上饮水记录
- **When**: 查看数据分析
- **Then**: 显示"你的黄金饮水时段：上午 9-10 点"
- **验证**: 基于历史 IntakeTime 聚合计算

#### R2.3: 饮水间隔分析

**场景 R2.3.1: 检测长时间未饮水**
- **Given**: 用户今日记录中存在 4 小时以上间隔
- **When**: 查看今日详情
- **Then**: 显示提示"14:00-18:00 未饮水，建议补充"

#### R2.4: 综合健康评分

**场景 R2.4.1: 计算每日健康评分**
- **Given**: 用户完成今日饮水记录
- **When**: 查看统计页面
- **Then**: 显示综合评分（0-100），基于：
  - 目标完成度 (40%)
  - 饮水规律性 (30%)
  - 类别多样性 (15%)
  - 间隔均匀度 (15%)

#### 约束
- 后端必须实现 streak 计算逻辑（当前字段存在但未计算）
- 所有新分析 API 遵循现有 `/api/v1/stats/*` 路由规范
- 返回 JSON 格式与现有 API 保持一致

---

### R3: 植物生长动画优化

**描述**：实现植物状态变化的自然生长动画效果

#### 场景 R3.1: 平滑缩放生长
- **Given**: 用户饮水量从 45% 增加到 55%（触发阶段变化）
- **When**: 植物从"幼苗"变为"成树"
- **Then**: 植物从小到大缩放动画，持续 800-1000ms
- **验证**: 使用 CSS transform: scale() + ease-out 曲线

#### 场景 R3.2: 生长发光效果
- **Given**: 植物阶段正在变化
- **When**: 动画进行中
- **Then**: 显示黄绿渐变光芒脉冲效果
- **验证**: 使用 CSS box-shadow 或 filter: blur() 动画

#### 场景 R3.3: 无闪烁切换
- **Given**: 植物阶段变化
- **When**: 旧图片淡出，新图片淡入
- **Then**: 过渡平滑无跳跃，两张图片交叉淡化
- **验证**: 使用 opacity 过渡 + 绝对定位叠加

#### 约束
- 动画总时长 800-1200ms
- 使用 CSS transitions/animations，避免 JS 动画（性能考虑）
- 保持 isTransitioning 锁机制防止快速切换
- 添加 will-change 优化渲染性能

---

## Success Criteria 成功标准

| 标准 | 验证方式 |
|------|----------|
| 30ml "一小口"选项可用 | UI 测试 + API 调用验证 |
| 连续达标天数正确计算并显示 | 单元测试 + 手动验证 |
| 最佳饮水时段分析生成 | API 返回有效数据 |
| 饮水间隔检测工作 | 插入测试数据验证 |
| 植物动画无闪烁 | 视觉审查 + 性能分析 |

---

## Dependencies 依赖

### 前端
- 无新增依赖
- 使用现有 lucide-react 图标库
- 使用现有 recharts 图表库

### 后端
- 无新增依赖
- 需实现 streak 计算逻辑
- 需新增分析 API 端点

---

## Risks 风险

| 风险 | 等级 | 缓解措施 |
|------|------|----------|
| 植物动画在低端设备卡顿 | 中 | 添加 will-change + 降级方案 |
| streak 计算在历史数据修改时不一致 | 中 | 前向传播重新计算 |

---

## Out of Scope 范围外

- Capacitor 打包配置（用户自行处理）
- 推送通知功能
- 多语言支持（仅保持中文）
